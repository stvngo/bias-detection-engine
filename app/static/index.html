<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-50">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Bias Lab - Advanced Media Bias Detection Engine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <style>
        .bias-meter {
            background: linear-gradient(90deg, #dc2626 0%, #ea580c 25%, #eab308 50%, #16a34a 75%, #2563eb 100%);
            height: 12px;
            border-radius: 6px;
            position: relative;
        }
        .bias-meter-pointer {
            position: absolute;
            top: -4px;
            width: 20px;
            height: 20px;
            background-color: #3b82f6;
            border-radius: 50%;
            border: 2px solid white;
            transform: translateX(-50%);
            transition: left 0.5s ease-out;
        }
        .radar-chart-container {
            position: relative;
            height: 300px;
            width: 300px;
            margin: auto;
        }
        .cluster-point {
            border-radius: 50%;
            width: 8px;
            height: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .cluster-point:hover {
            transform: scale(2);
        }
        .highlighted-phrase {
            background-color: #fef3c7;
            padding: 4px 6px;
            border-radius: 4px;
            border-left: 3px solid #f59e0b;
            margin: 4px 0;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .highlighted-phrase:hover {
            background-color: #fde68a;
            transform: translateX(2px);
        }
        .dimension-score-bar {
            height: 20px;
            background: linear-gradient(90deg, #dc2626 0%, #ea580c 25%, #eab308 50%, #16a34a 75%, #2563eb 100%);
            border-radius: 10px;
            position: relative;
            margin: 4px 0;
        }
        .dimension-score-indicator {
            position: absolute;
            top: -2px;
            width: 4px;
            height: 24px;
            background-color: #1f2937;
            border-radius: 2px;
            transform: translateX(-50%);
        }
    </style>
</head>

<body class="h-full bg-gray-50" x-data="biasApp()">
    <!-- Header -->
    <div class="bg-white border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="py-12 text-center">
                <div class="flex justify-center items-center mb-4">
                    <img src="/static/biaslab.png" alt="The Bias Lab Logo" class="h-20 w-auto">
                </div>
                <p class="text-xl text-gray-600 mb-6">
                    Advanced AI-Powered Media Bias Detection with Real-Time News Analysis
                </p>
                <div class="flex justify-center space-x-8 text-sm text-gray-700">
                    <div class="flex items-center">
                        <div class="w-3 h-3 bg-green-500 rounded-full mr-2"></div>
                        OpenAI GPT-3.5 Turbo
                    </div>
                    <div class="flex items-center">
                        <div class="w-3 h-3 bg-blue-500 rounded-full mr-2"></div>
                        Narrative Clustering
                    </div>
                    <div class="flex items-center">
                        <div class="w-3 h-3 bg-purple-500 rounded-full mr-2"></div>
                        Sub-500ms Analysis
                    </div>
                    <div class="flex items-center">
                        <div class="w-3 h-3 bg-red-500 rounded-full mr-2"></div>
                        Explainable AI
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation Tabs -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-8">
        <div class="border-b border-gray-200">
            <nav class="-mb-px flex space-x-8">
                <button @click="activeTab = 'single'" 
                        :class="activeTab === 'single' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                        class="whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">
                    Single Article Analysis
                </button>
                <button @click="activeTab = 'news'" 
                        :class="activeTab === 'news' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                        class="whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">
                    Real-Time News Analysis
                </button>
                <button @click="activeTab = 'clustering'" 
                        :class="activeTab === 'clustering' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                        class="whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">
                    Narrative Clustering
                </button>
                <button @click="activeTab = 'coverage'" 
                        :class="activeTab === 'coverage' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                        class="whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">
                    Story Coverage Analysis
                </button>
            </nav>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

        <!-- Single Article Analysis Tab -->
        <div x-show="activeTab === 'single'" class="space-y-8">
            <!-- Control Panel -->
            <div class="bg-white shadow-lg rounded-lg p-6">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Analyze Article Bias</h2>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div>
                        <label for="articleTitle" class="block text-sm font-medium text-gray-700">Article Title</label>
                        <input type="text" id="articleTitle" x-model="article.title" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="articleSource" class="block text-sm font-medium text-gray-700">Source</label>
                        <input type="text" id="articleSource" x-model="article.source" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="articleURL" class="block text-sm font-medium text-gray-700">URL (Optional)</label>
                        <input type="url" id="articleURL" x-model="article.url" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>

                <div class="mb-6">
                    <label for="articleContent" class="block text-sm font-medium text-gray-700">Article Content</label>
                    <textarea id="articleContent" x-model="article.content" rows="8" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>

                <div class="flex flex-col sm:flex-row justify-between items-center space-y-4 sm:space-y-0 sm:space-x-4">
                    <div class="flex space-x-4">
                        <button @click="analyzeBias" :disabled="loading" class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed">
                            <span x-show="!loading">Analyze Bias</span>
                            <span x-show="loading" class="flex items-center">
                                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                Analyzing...
                            </span>
                        </button>
                        <button @click="loadSampleArticles" :disabled="loading" class="inline-flex items-center px-6 py-3 border border-gray-300 text-base font-medium rounded-md shadow-sm text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed">
                            Load Sample Articles
                        </button>
                    </div>
                    <div x-show="analysisResult" class="text-sm text-gray-600">
                        <span x-text="`Processing Time: ${analysisResult.processing_time_ms} ms`"></span>
                        <span x-text="` | Model: ${analysisResult.model_used}`"></span>
                    </div>
                </div>

                <div x-show="errorMessage" class="mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-md" x-text="errorMessage"></div>
            </div>

            <!-- Analysis Results -->
            <div x-show="analysisResult" x-transition class="bg-white shadow-lg rounded-lg p-6">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6">Bias Analysis Results</h2>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Overall Score & Detailed Dimensions -->
                    <div>
                        <h3 class="text-xl font-medium text-gray-700 mb-2">Overall Bias Score: <span class="font-bold" :class="getOverallScoreColor(analysisResult.overall_score)" x-text="`${analysisResult.overall_score.toFixed(1)}/100`"></span></h3>
                        <p class="text-gray-600 mb-4" x-text="getOverallScoreDescription(analysisResult.overall_score)"></p>

                        <div class="bias-meter mb-6">
                            <div class="bias-meter-pointer" :style="`left: ${analysisResult.overall_score}%`"></div>
                        </div>

                        <h3 class="text-xl font-medium text-gray-700 mb-4">All 5 Dimension Scores:</h3>
                        <div class="space-y-4">
                            <template x-for="(score, dimension) in analysisResult.dimension_scores" :key="dimension">
                                <div>
                                    <div class="flex justify-between items-center mb-1">
                                        <span class="font-medium text-gray-700" x-text="formatDimensionName(dimension)"></span>
                                        <div class="text-right">
                                            <span :class="getDimensionScoreColor(score)" class="font-bold" x-text="`${score}/100`"></span>
                                            <span class="text-xs text-gray-500 ml-2" x-text="getConfidenceInterval(analysisResult.confidence_intervals, dimension)"></span>
                                        </div>
                                    </div>
                                    <div class="dimension-score-bar">
                                        <div class="dimension-score-indicator" :style="`left: ${score}%`"></div>
                                    </div>
                                    <p class="text-xs text-gray-600 mt-1" x-text="getDimensionExplanation(dimension, score)"></p>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- Radar Chart -->
                    <div class="flex justify-center items-center">
                        <div class="radar-chart-container">
                            <canvas id="biasRadarChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Explainable AI Section -->
                <div class="mt-8 border-t pt-8">
                    <h3 class="text-xl font-medium text-gray-700 mb-4">🔍 Explainable AI - Why This Article Scored As It Did</h3>
                    
                    <div x-show="analysisResult.highlighted_phrases && analysisResult.highlighted_phrases.length > 0" class="mb-6">
                        <h4 class="text-lg font-medium text-gray-700 mb-3">Key Bias Indicators:</h4>
                        <template x-for="(phrase, index) in analysisResult.highlighted_phrases" :key="index">
                            <div class="highlighted-phrase mb-3" @click="showPhraseDetails(phrase)">
                                <div class="flex justify-between items-start">
                                    <div class="flex-1">
                                        <p class="text-gray-800 font-semibold mb-1" x-text="`'${phrase.text}'`"></p>
                                        <p class="text-gray-600 text-sm" x-text="phrase.explanation"></p>
                                        <div class="flex items-center mt-2 space-x-4">
                                            <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded" x-text="`${phrase.confidence}% confidence`"></span>
                                            <span class="text-xs text-gray-500" x-text="Object.keys(phrase.score_impact || {}).map(dim => `${formatDimensionName(dim)}: ${phrase.score_impact[dim] > 0 ? '+' : ''}${phrase.score_impact[dim].toFixed(1)}`).join(', ')"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                    
                    <div x-show="!analysisResult.highlighted_phrases || analysisResult.highlighted_phrases.length === 0" class="text-gray-500 italic mb-6">
                        No specific bias indicators highlighted. The article appears relatively neutral across all dimensions.
                    </div>

                    <!-- Score Explanation -->
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h4 class="font-medium text-blue-900 mb-2">Score Breakdown:</h4>
                        <template x-for="(score, dimension) in analysisResult.dimension_scores" :key="dimension">
                            <p class="text-sm text-blue-800 mb-1">
                                <span class="font-medium" x-text="formatDimensionName(dimension)"></span>: 
                                <span x-text="getDetailedScoreExplanation(dimension, score)"></span>
                            </p>
                        </template>
                    </div>
                </div>
            </div>
        </div>

        <!-- Real-Time News Analysis Tab -->
        <div x-show="activeTab === 'news'" class="space-y-8">
            <div class="bg-white shadow-lg rounded-lg p-6">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Real-Time News Bias Analysis</h2>
                <p class="text-gray-600 mb-6">Analyze current news articles from multiple sources to detect bias patterns. Enter a specific topic for targeted analysis.</p>
                <div class="bg-green-50 p-3 rounded-lg mb-4 border border-green-200">
                    <div class="flex items-center text-xs text-green-700">
                        <span class="mr-2">⚡</span>
                        <span><strong>Optimized Processing:</strong> Uses concise AI analysis (300 tokens) for fast, accurate bias scoring with confidence intervals</span>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <label for="newsTopic" class="block text-sm font-medium text-gray-700">Topic</label>
                        <input type="text" id="newsTopic" x-model="newsAnalysis.topic" placeholder="e.g., Ukraine war, election 2024, climate change" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="maxArticles" class="block text-sm font-medium text-gray-700">Max Articles</label>
                        <select id="maxArticles" x-model="newsAnalysis.max_articles" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="10">10 articles</option>
                            <option value="15">15 articles</option>
                            <option value="20" selected>20 articles</option>
                        </select>
                    </div>
                </div>

                <button @click="analyzeCurrentNews" :disabled="newsLoading" class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 disabled:opacity-50 disabled:cursor-not-allowed">
                    <span x-show="!newsLoading">Analyze Current News</span>
                    <span x-show="newsLoading" class="flex items-center">
                        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Fetching & Analyzing...
                    </span>
                </button>

                <div x-show="newsErrorMessage" class="mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-md" x-text="newsErrorMessage"></div>
            </div>

            <!-- News Analysis Results -->
            <div x-show="newsResults" x-transition class="bg-white shadow-lg rounded-lg p-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">News Analysis Results</h3>
                
                <!-- Performance Metrics -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <p class="text-sm text-blue-600 font-medium">Topic Analyzed</p>
                        <p class="text-lg font-bold text-blue-900" x-text="newsResults.topic"></p>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg">
                        <p class="text-sm text-green-600 font-medium">Articles Fetched</p>
                        <p class="text-lg font-bold text-green-900" x-text="newsResults.articles_analyzed"></p>
                        <p class="text-xs text-green-700 mt-1">
                            <span x-text="(newsResults.narrative_clusters || []).reduce((total, cluster) => total + cluster.articles.length, 0)"></span> displayed
                        </p>
                    </div>
                    <div class="bg-purple-50 p-4 rounded-lg">
                        <p class="text-sm text-purple-600 font-medium">Article Gathering Time</p>
                        <p class="text-lg font-bold text-purple-900" x-text="`${Math.round(newsResults.processing_time_ms * 0.1)} ms`"></p>
                    </div>
                    <div class="bg-yellow-50 p-4 rounded-lg">
                        <p class="text-sm text-yellow-600 font-medium">Analysis Time per Article</p>
                        <p class="text-lg font-bold text-yellow-900" x-text="`${Math.round((newsResults.processing_time_ms * 0.9) / newsResults.articles_analyzed)} ms`"></p>
                    </div>
                </div>

                <!-- Article Grid with All 5 Dimensions -->
                <div class="mb-8">
                    <h4 class="text-lg font-medium text-gray-800 mb-4">
                        Analyzed Articles - Full Bias Profiles 
                        <span class="text-sm text-gray-600 ml-2">(
                            <span x-text="(newsResults.narrative_clusters || []).reduce((total, cluster) => total + cluster.articles.length, 0)"></span> 
                            of <span x-text="newsResults.articles_analyzed"></span> articles displayed)
                        </span>
                    </h4>
                                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Debug info -->
                        <div x-show="getAllArticles().length === 0" class="col-span-full text-center py-8 text-gray-500">
                            <p>No articles to display. Debug info:</p>
                            <p>_allArticles length: <span x-text="_allArticles.length"></span></p>
                            <p>newsResults exists: <span x-text="!!newsResults"></span></p>
                            <p x-show="newsResults">narrative_clusters length: <span x-text="newsResults.narrative_clusters ? newsResults.narrative_clusters.length : 'undefined'"></span></p>
                            <p x-show="newsResults && newsResults.narrative_clusters">First cluster articles: <span x-text="newsResults.narrative_clusters[0] ? newsResults.narrative_clusters[0].articles.length : 'undefined'"></span></p>
                        </div>
                        
                        <template x-for="article in getAllArticles()" :key="article._uniqueId || `${article.source}-${article.title}`">
                            <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                                <!-- Debug article structure -->
                                <div x-show="false" class="text-xs text-gray-400 mb-2">
                                    <p>Debug - Article keys: <span x-text="Object.keys(article).join(', ')"></span></p>
                                    <p x-show="article.analysis">Analysis keys: <span x-text="Object.keys(article.analysis || {}).join(', ')"></span></p>
                                    <p x-show="article.analysis?.dimension_scores">Dimension scores keys: <span x-text="Object.keys(article.analysis?.dimension_scores || {}).join(', ')"></span></p>
                                </div>
                                
                                <h5 class="font-medium text-gray-900 mb-2 text-sm leading-tight" x-text="article.title.substring(0, 60) + '...'"></h5>
                                <p class="text-xs text-gray-600 mb-2" x-text="article.source"></p>
                                <p class="text-xs text-gray-500 mb-3 italic" x-text="truncateContent(article.content, 120)"></p>
                                
                                <!-- Overall Score -->
                                <div class="mb-3">
                                    <div class="flex justify-between items-center mb-1">
                                        <span class="text-xs font-medium text-gray-700">Overall Bias</span>
                                        <span class="text-xs font-bold" 
                                              :class="(article.analysis?.overall_score || article.overall_bias_score || 50) > 70 ? 'text-green-600' : (article.analysis?.overall_score || article.overall_bias_score || 50) > 40 ? 'text-yellow-600' : 'text-red-600'"
                                              x-text="`${(article.analysis?.overall_score || article.overall_bias_score || 50)}/100`"></span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-2">
                                        <div class="h-2 rounded-full transition-all duration-500" 
                                             :class="(article.analysis?.overall_score || article.overall_bias_score || 50) > 70 ? 'bg-green-500' : (article.analysis?.overall_score || article.overall_bias_score || 50) > 40 ? 'bg-green-500' : 'bg-red-500'"
                                             :style="`width: ${(article.analysis?.overall_score || article.overall_bias_score || 50)}%`"></div>
                                    </div>
                                </div>

                                <!-- All 5 Dimensions from Analysis -->
                                <div class="space-y-2">
                                    <template x-for="(score, dimension) in (article.analysis?.dimension_scores || article.bias_profile || {})" :key="dimension">
                                        <div class="flex justify-between items-center text-xs">
                                            <span class="text-gray-600" x-text="formatDimensionName(dimension)"></span>
                                            <span class="font-medium" :class="getDimensionScoreColor(score)" x-text="score"></span>
                                        </div>
                                    </template>
                                </div>

                                <!-- Confidence Intervals if Available -->
                                <div x-show="article.analysis?.confidence_intervals" class="mt-2 text-xs text-gray-500">
                                    <span class="font-medium">Confidence: </span>
                                    <template x-for="(interval, dim) in (article.analysis?.confidence_intervals || {})" :key="dim">
                                        <span class="mr-1 text-xs" x-text="`${formatDimensionName(dim)}: (${interval[0]}-${interval[1]})`"></span>
                                    </template>
                                </div>

                                <div class="mt-3 flex justify-between items-center">
                                    <span class="text-xs text-blue-600 font-medium" x-text="`Cluster ${getArticleCluster(article) + 1}`"></span>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>

        <!-- Narrative Clustering Tab -->
        <div x-show="activeTab === 'clustering'" class="space-y-8">
            <!-- NEW: Clustering Warning Banner -->
            <div x-show="newsResults?.clustering_recommendation && !newsResults.clustering_recommendation.should_cluster" class="bg-red-50 border border-red-200 rounded-lg p-4">
                <div class="flex items-start space-x-3">
                    <div class="flex-shrink-0">
                        <div class="w-6 h-6 bg-red-100 rounded-full flex items-center justify-center">
                            <span class="text-red-600 text-sm">⚠️</span>
                        </div>
                    </div>
                    <div class="flex-1">
                        <h3 class="text-lg font-medium text-red-800 mb-2">Clustering Not Recommended</h3>
                        <p class="text-red-700 mb-2" x-text="newsResults.clustering_recommendation.reasoning"></p>
                        <p class="text-red-600 text-sm"><strong>Recommendation:</strong> <span x-text="newsResults.clustering_recommendation.recommended_approach"></span></p>
                        <div x-show="newsResults.clustering_recommendation.warnings.length > 0" class="mt-2">
                            <p class="text-red-600 text-sm font-medium">Key Concerns:</p>
                            <ul class="list-disc list-inside text-red-600 text-sm mt-1 space-y-1">
                                <template x-for="warning in newsResults.clustering_recommendation.warnings" :key="warning">
                                    <li x-text="warning"></li>
                                </template>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            
            <div x-show="newsResults?.cluster_visualizations" class="bg-white shadow-lg rounded-lg p-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-6">Advanced Narrative Clustering Visualizations</h3>
                
                <!-- NEW: Clustering Transparency & Quality Section -->
                <div x-show="newsResults?.clustering_insights || newsResults?.clustering_recommendation" class="bg-gradient-to-r from-amber-50 to-orange-50 border border-amber-200 rounded-lg p-6 mb-8">
                    <h4 class="text-lg font-medium text-amber-800 mb-4">🔍 Clustering Transparency & Quality Assessment</h4>
                    
                    <!-- Clustering Recommendation -->
                    <div x-show="newsResults?.clustering_recommendation" class="mb-6">
                        <div class="flex items-start space-x-3">
                            <div class="flex-shrink-0">
                                <div x-show="newsResults.clustering_recommendation.should_cluster" class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center">
                                    <span class="text-green-600 text-lg">✅</span>
                                </div>
                                <div x-show="!newsResults.clustering_recommendation.should_cluster" class="w-8 h-8 bg-red-100 rounded-full flex items-center justify-center">
                                    <span class="text-red-600 text-lg">⚠️</span>
                                </div>
                            </div>
                            <div class="flex-1">
                                <h5 class="font-medium text-amber-800 mb-2" x-text="newsResults.clustering_recommendation.should_cluster ? 'Clustering Recommended' : 'Clustering Not Recommended'"></h5>
                                <p class="text-sm text-amber-700 mb-2" x-text="newsResults.clustering_recommendation.reasoning"></p>
                                <p class="text-sm text-amber-600 mb-2"><span class="font-medium">Approach:</span> <span x-text="newsResults.clustering_recommendation.recommended_approach"></span></p>
                                <div x-show="newsResults.clustering_recommendation.warnings.length > 0" class="mt-2">
                                    <p class="text-sm font-medium text-amber-700 mb-1">Warnings:</p>
                                    <ul class="list-disc list-inside text-sm text-amber-600 space-y-1">
                                        <template x-for="warning in newsResults.clustering_recommendation.warnings" :key="warning">
                                            <li x-text="warning"></li>
                                        </template>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Clustering Insights -->
                    <div x-show="newsResults?.clustering_insights" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white p-4 rounded border border-amber-200">
                            <h5 class="font-medium text-amber-800 mb-3">📊 Clustering Quality Metrics</h5>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-amber-700">Total Articles:</span>
                                    <span class="font-medium" x-text="newsResults.clustering_insights.total_articles"></span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-amber-700">Clusters Created:</span>
                                    <span class="font-medium" x-text="newsResults.clustering_insights.total_clusters"></span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-amber-700">Quality Level:</span>
                                    <span class="font-medium capitalize" x-text="newsResults.clustering_insights.clustering_quality.replace('_', ' ')"></span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-amber-700">Size Balance:</span>
                                    <span class="font-medium capitalize" x-text="newsResults.clustering_insights.size_balance.replace('_', ' ')"></span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white p-4 rounded border border-amber-200">
                            <h5 class="font-medium text-amber-800 mb-3">💡 Recommendations & Insights</h5>
                            <div class="space-y-2">
                                <template x-for="recommendation in newsResults.clustering_insights.recommendations" :key="recommendation">
                                    <div class="flex items-start space-x-2">
                                        <span class="text-amber-500 text-sm">•</span>
                                        <p class="text-sm text-amber-700" x-text="recommendation"></p>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- NEW: Overall Clustering Summary -->
                <div x-show="newsResults.clustering_insights" class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-lg p-6 mb-8">
                    <h4 class="text-lg font-medium text-blue-800 mb-4">📈 Overall Clustering Summary</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="text-center">
                            <div class="text-3xl font-bold text-blue-600 mb-2" x-text="newsResults.clustering_insights.total_clusters"></div>
                            <div class="text-sm text-blue-700">Clusters Created</div>
                            <div class="text-xs text-blue-600 mt-1" x-text="newsResults.clustering_insights.clustering_quality.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())"></div>
                        </div>
                        <div class="text-center">
                            <div class="text-3xl font-bold text-indigo-600 mb-2" x-text="newsResults.clustering_insights.total_articles"></div>
                            <div class="text-sm text-indigo-700">Articles Analyzed</div>
                            <div class="text-xs text-indigo-600 mt-1">Analysis Complete</div>
                        </div>
                        <div class="text-center">
                            <div class="text-3xl font-bold text-green-600 mb-2" x-text="newsResults.clustering_insights.size_balance.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())"></div>
                            <div class="text-sm text-green-700">Size Distribution</div>
                            <div class="text-xs text-green-600 mt-1">Cluster Balance</div>
                        </div>
                    </div>
                </div>
                
                <!-- NEW: Single Cluster Display -->
                <div x-show="newsResults.narrative_clusters && newsResults.narrative_clusters.length === 1" class="bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 rounded-lg p-6 mb-8">
                    <div class="text-center">
                        <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <span class="text-green-600 text-2xl">📊</span>
                        </div>
                        <h4 class="text-xl font-medium text-green-800 mb-2">Single Cluster Analysis</h4>
                        <p class="text-green-700 mb-4">The algorithm detected that all articles share similar narrative patterns, suggesting no natural groupings exist in this dataset.</p>
                        
                        <div x-show="newsResults.clustering_insights" class="bg-white p-4 rounded border border-green-200 inline-block">
                            <div class="text-sm text-green-800">
                                <p><strong>Quality Assessment:</strong> <span x-text="newsResults.clustering_insights.clustering_quality.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())"></span></p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Cluster Summary Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                    <template x-for="cluster in newsResults.narrative_clusters" :key="cluster.cluster_id">
                        <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                            <div class="flex justify-between items-start mb-3">
                                <h4 class="text-lg font-medium text-gray-900" x-text="`Narrative ${cluster.cluster_id + 1}`"></h4>
                                <span class="bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded" x-text="`${cluster.size} articles`"></span>
                            </div>
                            
                            <!-- Complete Bias Profile -->
                            <div class="mb-4">
                                <p class="text-sm font-medium text-gray-700 mb-2">Complete Bias Profile (0-100):</p>
                                <div class="space-y-1 text-xs">
                                    <div class="flex justify-between">
                                        <span>Ideological Stance:</span>
                                        <span class="font-medium" x-text="cluster.bias_profile.ideological_stance.toFixed(1)"></span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Factual Grounding:</span>
                                        <span class="font-medium" x-text="cluster.bias_profile.factual_grounding.toFixed(1)"></span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Framing Choices:</span>
                                        <span class="font-medium" x-text="cluster.bias_profile.framing_choices.toFixed(1)"></span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Emotional Tone:</span>
                                        <span class="font-medium" x-text="cluster.bias_profile.emotional_tone.toFixed(1)"></span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Source Transparency:</span>
                                        <span class="font-medium" x-text="cluster.bias_profile.source_transparency.toFixed(1)"></span>
                                    </div>
                                </div>
                            </div>

                            <!-- Dominant Themes -->
                            <div class="mb-4">
                                <p class="text-sm font-medium text-gray-700 mb-2">Key Themes:</p>
                                <div class="flex flex-wrap gap-1">
                                    <template x-for="theme in cluster.dominant_themes.slice(0, 3)" :key="theme">
                                        <span class="bg-gray-100 text-gray-700 text-xs px-2 py-1 rounded" x-text="theme"></span>
                                    </template>
                                </div>
                            </div>

                            <!-- Representative Phrases -->
                            <div>
                                <p class="text-sm font-medium text-gray-700 mb-2">Sample Phrases:</p>
                                
                                <div x-data="{ phrases: cluster.representative_phrases || [] }">
                                    <template x-for="phrase in phrases.slice(0, 3)">
                                        <div class="bg-gray-50 p-2 rounded text-xs text-gray-700 mb-1 border-l-2 border-blue-300">
                                            <span class="italic" x-text="phrase"></span>
                                        </div>
                                    </template>
                                    
                                    <div x-show="phrases.length === 0" class="text-xs text-gray-500 italic">
                                        No sample phrases available
                                    </div>
                                </div>
                            </div>
                            
                            <!-- NEW: Clustering Explanation -->
                            <div x-show="cluster.clustering_explanation" class="mt-4 pt-3 border-t border-gray-200">
                                <p class="text-sm font-medium text-gray-700 mb-2">🔍 Why This Cluster Exists:</p>
                                <div class="bg-blue-50 p-3 rounded text-xs text-blue-800 border-l-3 border-blue-400">
                                    <p class="italic leading-relaxed" x-text="cluster.clustering_explanation"></p>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>


                
                <!-- Enhanced Scoring Guidelines -->
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-lg p-6 mb-8">
                    <h4 class="text-lg font-medium text-blue-800 mb-4">📊 Enhanced Scoring Guidelines (0-100 Scale)</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 text-sm">
                        <div class="bg-white p-3 rounded border border-blue-200">
                            <h5 class="font-medium text-blue-800 mb-2">Ideological Stance</h5>
                            <div class="space-y-1 text-xs">
                                <div class="flex justify-between"><span>0-20:</span><span class="text-red-600">Strong left/progressive</span></div>
                                <div class="flex justify-between"><span>21-40:</span><span class="text-orange-600">Moderate left</span></div>
                                <div class="flex justify-between"><span>41-60:</span><span class="text-yellow-600">Center/balanced</span></div>
                                <div class="flex justify-between"><span>61-80:</span><span class="text-orange-600">Moderate right</span></div>
                                <div class="flex justify-between"><span>81-100:</span><span class="text-red-600">Strong right/conservative</span></div>
                            </div>
                        </div>
                        <div class="bg-white p-3 rounded border border-blue-200">
                            <h5 class="font-medium text-blue-800 mb-2">Factual Grounding</h5>
                            <div class="space-y-1 text-xs">
                                <div class="flex justify-between"><span>0-20:</span><span class="text-red-600">Unverified claims</span></div>
                                <div class="flex justify-between"><span>21-40:</span><span class="text-orange-600">Poor verification</span></div>
                                <div class="flex justify-between"><span>41-60:</span><span class="text-yellow-600">Mixed verification</span></div>
                                <div class="flex justify-between"><span>61-80:</span><span class="text-green-600">Good verification</span></div>
                                <div class="flex justify-between"><span>81-100:</span><span class="text-green-600">Well-sourced facts</span></div>
                            </div>
                        </div>
                        <div class="bg-white p-3 rounded border border-blue-200">
                            <h5 class="font-medium text-blue-800 mb-2">Framing Choices</h5>
                            <div class="space-y-1 text-xs">
                                <div class="flex justify-between"><span>0-20:</span><span class="text-red-600">Heavy bias</span></div>
                                <div class="flex justify-between"><span>21-40:</span><span class="text-orange-600">Significant bias</span></div>
                                <div class="flex justify-between"><span>41-60:</span><span class="text-yellow-600">Moderate bias</span></div>
                                <div class="flex justify-between"><span>61-80:</span><span class="text-green-600">Minimal bias</span></div>
                                <div class="flex justify-between"><span>81-100:</span><span class="text-green-600">Objective</span></div>
                            </div>
                        </div>
                        <div class="bg-white p-3 rounded border border-blue-200">
                            <h5 class="font-medium text-blue-800 mb-2">Emotional Tone</h5>
                            <div class="space-y-1 text-xs">
                                <div class="flex justify-between"><span>0-20:</span><span class="text-red-600">Highly inflammatory</span></div>
                                <div class="flex justify-between"><span>21-40:</span><span class="text-orange-600">Significantly emotional</span></div>
                                <div class="flex justify-between"><span>41-60:</span><span class="text-yellow-600">Moderate emotion</span></div>
                                <div class="flex justify-between"><span>61-80:</span><span class="text-green-600">Minimal emotion</span></div>
                                <div class="flex justify-between"><span>81-100:</span><span class="text-green-600">Neutral/analytical</span></div>
                            </div>
                        </div>
                        <div class="bg-white p-3 rounded border border-blue-200">
                            <h5 class="font-medium text-blue-800 mb-2">Source Transparency</h5>
                            <div class="space-y-1 text-xs">
                                <div class="flex justify-between"><span>0-20:</span><span class="text-red-600">Anonymous sources</span></div>
                                <div class="flex justify-between"><span>21-40:</span><span class="text-orange-600">Poor attribution</span></div>
                                <div class="flex justify-between"><span>41-60:</span><span class="text-yellow-600">Some attribution</span></div>
                                <div class="flex justify-between"><span>61-80:</span><span class="text-green-600">Good attribution</span></div>
                                <div class="flex justify-between"><span>81-100:</span><span class="text-green-600">Clear named sources</span></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Cross-Outlet Comparison Section -->
                <div class="bg-white border border-gray-200 rounded-lg p-6 mb-8">
                    <h4 class="text-lg font-medium text-gray-800 mb-4">🧠 Intelligent Cross-Outlet Comparison</h4>
                    <p class="text-sm text-gray-600 mb-4">Automatically compare contrasting news outlets from your analysis to reveal media bias patterns. The system intelligently selects the most contrasting articles based on bias scores and clustering.</p>
                    <div class="bg-blue-50 p-3 rounded-lg mb-4 border border-blue-200">
                        <div class="flex items-center text-xs text-blue-700">
                            <span class="mr-2">⚡</span>
                            <span><strong>Enhanced Analysis:</strong> Uses extended AI processing (1000 tokens) for detailed cross-outlet comparison vs. concise scoring (300 tokens) for individual articles</span>
                        </div>
                    </div>
                    
                    <!-- Automatic Comparison Trigger -->
                    <div class="text-center mb-6">
                        <button @click="autoCompareOutlets()" :disabled="comparisonLoading || !hasAnalysisResults" class="inline-flex items-center px-8 py-4 border border-transparent text-base font-medium rounded-md text-white bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200 shadow-lg">
                            <span x-show="!comparisonLoading">🧠 Auto-Compare Contrasting Outlets</span>
                            <span x-show="comparisonLoading">🔍 Analyzing Contrasts...</span>
                        </button>
                        
                        <div x-show="!hasAnalysisResults" class="mt-3 text-sm text-gray-500">
                            Run a news analysis first to enable automatic outlet comparison
                        </div>
                    </div>

                    <!-- Comparison Results -->
                    <div x-show="comparisonResults" class="border-t border-gray-200 pt-6">
                        <h5 class="text-md font-medium text-gray-800 mb-3">Intelligent Comparison Analysis</h5>
                        
                        <!-- Selection Strategy Info -->
                        <div x-show="comparisonResults.selection_strategy" class="bg-indigo-50 p-4 rounded-lg mb-4 border border-indigo-200">
                            <h6 class="text-sm font-medium text-indigo-800 mb-2">🧠 Intelligent Selection Strategy</h6>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-xs">
                                <div>
                                    <span class="text-indigo-700 font-medium">Strategy:</span>
                                    <span class="ml-2 capitalize" x-text="comparisonResults.selection_strategy?.replace('_', ' ')"></span>
                                </div>
                                <div>
                                    <span class="text-indigo-700 font-medium">Articles Analyzed:</span>
                                    <span class="ml-2" x-text="comparisonResults.articles_selected_from"></span>
                                </div>
                                <div>
                                    <span class="text-indigo-700 font-medium">Clusters Found:</span>
                                    <span class="ml-2" x-text="comparisonResults.clusters_analyzed"></span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- AI-Generated Analysis -->
                        <div class="bg-gray-50 p-4 rounded-lg mb-4">
                            <div class="text-sm text-gray-700 leading-relaxed" x-html="formatComparisonAnalysis(comparisonResults.comparison_analysis)"></div>
                        </div>
                        
                        <!-- Quantitative Metrics -->
                        <div x-show="comparisonResults.comparison_metrics && !comparisonResults.comparison_metrics.error" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-blue-50 p-4 rounded-lg">
                                <h6 class="text-sm font-medium text-blue-800 mb-2">Score Variance Analysis</h6>
                                <div class="space-y-2 text-xs">
                                    <template x-for="(metrics, dimension) in comparisonResults.comparison_metrics.score_variance" :key="dimension">
                                        <div class="flex justify-between">
                                            <span class="text-blue-700" x-text="dimension.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())"></span>
                                            <span class="font-medium" x-text="`${metrics.mean} ±${Math.sqrt(metrics.variance).toFixed(1)}`"></span>
                                        </div>
                                    </template>
                                </div>
                            </div>
                            
                            <div class="bg-green-50 p-4 rounded-lg">
                                <h6 class="text-sm font-medium text-green-800 mb-2">Comparison Summary</h6>
                                <div class="space-y-2 text-xs">
                                    <div class="flex justify-between">
                                        <span class="text-green-700">Outlets Analyzed:</span>
                                        <span class="font-medium" x-text="comparisonResults.outlets_analyzed.join(', ')"></span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-green-700">Comparison Quality:</span>
                                        <span class="font-medium capitalize" x-text="comparisonResults.comparison_metrics.comparison_quality"></span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-green-700">Processing Time:</span>
                                        <span class="font-medium" x-text="`${comparisonResults.processing_time_ms}ms`"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Model Information -->
                        <div class="text-xs text-gray-500 mt-4 text-center">
                            Analysis powered by <span class="font-medium" x-text="comparisonResults.model_used"></span>
                        </div>
                    </div>
                </div>

                <!-- Multiple Visualization Types -->
                <div x-show="newsResults.cluster_visualizations" class="space-y-8">
                    <!-- PCA Visualization -->
                    <div x-show="newsResults.cluster_visualizations.pca" class="bg-gray-50 p-6 rounded-lg">
                        <h4 class="text-lg font-medium text-gray-800 mb-4" x-text="newsResults.cluster_visualizations.pca?.title"></h4>
                        <p class="text-sm text-gray-600 mb-4" x-text="`Explained Variance: PC1: ${Math.round((newsResults.cluster_visualizations.pca?.explained_variance[0] || 0) * 100)}%, PC2: ${Math.round((newsResults.cluster_visualizations.pca?.explained_variance[1] || 0) * 100)}%`"></p>
                        <div id="pcaVisualization" class="w-full h-96 bg-white rounded border"></div>
                    </div>

                    <!-- t-SNE Visualization -->
                    <div x-show="newsResults.cluster_visualizations.tsne" class="bg-gray-50 p-6 rounded-lg">
                        <h4 class="text-lg font-medium text-gray-800 mb-4" x-text="newsResults.cluster_visualizations.tsne?.title"></h4>
                        <p class="text-sm text-gray-600 mb-4" x-text="`Perplexity: ${newsResults.cluster_visualizations.tsne?.perplexity || 'N/A'}`"></p>
                        <div id="tsneVisualization" class="w-full h-96 bg-white rounded border"></div>
                    </div>

                    <!-- Bias Distribution -->
                    <div x-show="newsResults.cluster_visualizations.bias_distribution" class="bg-gray-50 p-6 rounded-lg">
                        <h4 class="text-lg font-medium text-gray-800 mb-4" x-text="newsResults.cluster_visualizations.bias_distribution?.title"></h4>
                        <div id="biasDistributionVisualization" class="w-full h-96 bg-white rounded border"></div>
                    </div>
                </div>
            </div>

            <div x-show="!newsResults" class="bg-white shadow-lg rounded-lg p-6 text-center">
                <p class="text-gray-500">Run a news analysis first to see narrative clustering results.</p>
                <button @click="activeTab = 'news'" class="mt-4 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-blue-600 bg-blue-100 hover:bg-blue-200">
                    Go to News Analysis
                </button>
            </div>
        </div>

        <!-- Story Coverage Analysis Tab -->
        <div x-show="activeTab === 'coverage'" class="space-y-8">
            <div x-show="newsResults?.story_coverage_analysis" class="bg-white shadow-lg rounded-lg p-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-6">📰 How Different Outlets Cover the Same Story</h3>
                
                <!-- Same Story Different Coverage -->
                <div x-show="newsResults?.story_coverage_analysis?.same_story_different_coverage?.length > 0" class="mb-8">
                    <h4 class="text-lg font-medium text-gray-800 mb-4">Same Story, Different Perspectives</h4>
                    <template x-for="coverage in newsResults.story_coverage_analysis.same_story_different_coverage" :key="coverage.topic">
                        <div class="border border-gray-200 rounded-lg p-4 mb-4">
                            <h5 class="font-medium text-gray-900 mb-2" x-text="`Topic: ${coverage.topic}`"></h5>
                            <p class="text-sm text-gray-600 mb-3" x-text="`Covered by ${coverage.sources.length} different sources with bias scores ranging from ${coverage.bias_range.min.toFixed(1)} to ${coverage.bias_range.max.toFixed(1)}`"></p>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                                <template x-for="(article, index) in coverage.articles" :key="`${coverage.topic}-${article.source}-${index}`">
                                    <div class="bg-gray-50 p-3 rounded">
                                        <p class="text-sm font-medium text-gray-900 mb-1" x-text="article.source"></p>
                                        <p class="text-xs text-gray-600 mb-2" x-text="article.title.substring(0, 80) + '...'"></p>
                                        <div class="flex justify-between items-center">
                                            <span class="text-xs text-gray-500">Bias Score:</span>
                                            <span class="text-xs font-bold" :class="getDimensionScoreColor(article.overall_score)" x-text="`${article.overall_score.toFixed(1)}/100`"></span>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </template>
                </div>

                <!-- Source Bias Spectrum -->
                <div x-show="newsResults?.story_coverage_analysis?.bias_spectrum_by_source" class="mb-8">
                    <h4 class="text-lg font-medium text-gray-800 mb-4">Bias Spectrum by News Source</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <template x-for="(data, source) in newsResults.story_coverage_analysis.bias_spectrum_by_source" :key="source">
                            <div class="border border-gray-200 rounded-lg p-4">
                                <h5 class="font-medium text-gray-900 mb-2" x-text="source"></h5>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Average Bias:</span>
                                        <span class="font-medium" :class="getDimensionScoreColor(data.average_bias)" x-text="`${data.average_bias.toFixed(1)}/100`"></span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Confidence:</span>
                                        <span class="font-medium" x-text="`${Math.round(data.bias_confidence)}%`"></span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Articles:</span>
                                        <span class="font-medium" x-text="data.article_count"></span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Range:</span>
                                        <span class="text-xs" x-text="`${data.score_range[0].toFixed(1)}-${data.score_range[1].toFixed(1)}`"></span>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>

            <div x-show="!newsResults || !newsResults.story_coverage_analysis" class="bg-white shadow-lg rounded-lg p-6 text-center">
                <p class="text-gray-500">Run a news analysis first to see story coverage analysis.</p>
                <button @click="activeTab = 'news'" class="mt-4 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-blue-600 bg-blue-100 hover:bg-blue-200">
                    Go to News Analysis
                </button>
            </div>
        </div>
    </div>

    <script>
        function biasApp() {
            return {
                activeTab: 'single',
                article: {
                    title: '',
                    content: '',
                    source: '',
                    url: ''
                },
                newsAnalysis: {
                    topic: '',
                    max_articles: 20
                },
                analysisResult: null,
                newsResults: null,
                loading: false,
                newsLoading: false,
                errorMessage: '',
                newsErrorMessage: '',
                radarChart: null,
                comparisonData: {
                    article1: { title: '', content: '', source: '' },
                    article2: { title: '', content: '', source: '' }
                },
                comparisonResults: null,
                comparisonLoading: false,
                hasAnalysisResults: false,
                _allArticles: [],

                init() {
                    this.$watch('analysisResult', (result) => {
                        if (result) {
                            this.updateRadarChart(result.dimension_scores);
                        }
                    });
                    this.$watch('newsResults', (results) => {
                        if (results && results.cluster_visualizations) {
                            setTimeout(() => {
                                this.renderClusterVisualizations(results.cluster_visualizations);
                            }, 100);
                        }
                    });
                },

                async analyzeBias() {
                    this.loading = true;
                    this.errorMessage = '';
                    this.analysisResult = null;
                    this.comparisonResults = null; // Clear cross-outlet comparison results

                    try {
                        const response = await fetch('/analyze/article', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.article)
                        });

                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.detail || 'Failed to analyze article');
                        }

                        this.analysisResult = await response.json();
                    } catch (error) {
                        this.errorMessage = error.message;
                        console.error('Analysis error:', error);
                    } finally {
                        this.loading = false;
                    }
                },

                async analyzeCurrentNews() {
                    this.newsLoading = true;
                    this.newsErrorMessage = '';
                    this.newsResults = null;
                    this.comparisonResults = null; // Clear cross-outlet comparison results
                    this._allArticles = []; // Clear previous articles for fast rendering

                    try {
                        const response = await fetch('/analyze/news', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.newsAnalysis)
                        });

                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.detail || 'Failed to analyze news');
                        }

                        this.newsResults = await response.json();
                        console.log('News analysis response:', this.newsResults);
                        
                        // Pre-process articles for fast display
                        this._allArticles = [];
                        if (this.newsResults?.narrative_clusters) {
                            console.log('Processing narrative clusters:', this.newsResults.narrative_clusters);
                            this.newsResults.narrative_clusters.forEach(cluster => {
                                console.log('Processing cluster:', cluster);
                                console.log('Cluster articles:', cluster.articles);
                                if (cluster.articles && Array.isArray(cluster.articles)) {
                                    cluster.articles.forEach((article, index) => {
                                        console.log('Processing article:', article);
                                        console.log('Article title:', article.title);
                                        console.log('Article analysis:', article.analysis);
                                        console.log('Article analysis.dimension_scores:', article.analysis?.dimension_scores);
                                        article._clusterId = cluster.cluster_id;
                                        article._uniqueId = `${cluster.cluster_id}-${index}`; // Add unique ID
                                        this._allArticles.push(article);
                                    });
                                }
                            });
                        }
                        console.log('Final _allArticles:', this._allArticles);
                        console.log('_allArticles length:', this._allArticles.length);
                        console.log('First article in _allArticles:', this._allArticles[0]);
                        if (this._allArticles[0]) {
                            console.log('First article analysis:', this._allArticles[0].analysis);
                            console.log('First article dimension_scores:', this._allArticles[0].analysis?.dimension_scores);
                        }
                        
                        this.hasAnalysisResults = true;
                        this.activeTab = 'news';
                    } catch (error) {
                        this.newsErrorMessage = error.message;
                        console.error('News analysis error:', error);
                    } finally {
                        this.newsLoading = false;
                    }
                },

                // Helper functions for displaying all articles
                getAllArticles() {
                    console.log('getAllArticles called, _allArticles:', this._allArticles);
                    console.log('_allArticles length:', this._allArticles.length);
                    
                    // If _allArticles is empty but we have newsResults, try to extract articles directly
                    if (this._allArticles.length === 0 && this.newsResults) {
                        console.log('_allArticles is empty, attempting to extract from newsResults');
                        if (this.newsResults.narrative_clusters) {
                            this.newsResults.narrative_clusters.forEach((cluster, clusterIndex) => {
                                if (cluster.articles && Array.isArray(cluster.articles)) {
                                    cluster.articles.forEach((article, articleIndex) => {
                                        article._clusterId = cluster.cluster_id;
                                        article._uniqueId = `${cluster.cluster_id}-${articleIndex}`; // Add unique ID
                                        this._allArticles.push(article);
                                    });
                                }
                            });
                        }
                        console.log('Extracted articles from newsResults:', this._allArticles);
                    }
                    
                    // Additional debugging
                    if (this._allArticles.length > 0) {
                        console.log('getAllArticles returning articles:');
                        this._allArticles.forEach((article, index) => {
                            console.log(`Article ${index}:`, {
                                title: article.title,
                                hasAnalysis: !!article.analysis,
                                hasDimensionScores: !!article.analysis?.dimension_scores,
                                dimensionScores: article.analysis?.dimension_scores
                            });
                        });
                    }
                    
                    return this._allArticles;
                },

                getArticleCluster(article) {
                    return article._clusterId || 0;
                },

                async loadSampleArticles() {
                    this.loading = true;
                    this.errorMessage = '';
                    this.analysisResult = null;

                    try {
                        const response = await fetch('/demo/sample-articles');
                        if (!response.ok) throw new Error('Failed to fetch sample articles');
                        
                        const samples = await response.json();
                        if (samples.length > 0) {
                            this.article = { ...samples[0] };
                            await this.analyzeBias();
                        } else {
                            this.errorMessage = 'No sample articles available.';
                        }
                    } catch (error) {
                        this.errorMessage = error.message;
                        console.error('Sample loading error:', error);
                    } finally {
                        this.loading = false;
                    }
                },

                renderClusterVisualizations(vizData) {
                    // Render PCA visualization
                    if (vizData.pca) {
                        this.renderScatterPlot('pcaVisualization', vizData.pca, 'PCA Components');
                    }
                    
                    // Render t-SNE visualization  
                    if (vizData.tsne) {
                        this.renderScatterPlot('tsneVisualization', vizData.tsne, 't-SNE Dimensions');
                    }
                    
                    // Render bias distribution
                    if (vizData.bias_distribution) {
                        this.renderBiasDistribution('biasDistributionVisualization', vizData.bias_distribution);
                    }
                },

                renderScatterPlot(containerId, data, axisLabel) {
                    const container = document.getElementById(containerId);
                    if (!container || !data.points) return;

                    container.innerHTML = `
                        <div class="w-full h-full relative">
                            <canvas id="${containerId}Chart" class="w-full h-full"></canvas>
                        </div>
                    `;

                    const canvas = container.querySelector('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    const colors = ['#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899'];
                    const datasets = {};
                    
                    data.points.forEach(point => {
                        const cluster = point.cluster;
                        if (!datasets[cluster]) {
                            datasets[cluster] = {
                                label: `Cluster ${cluster + 1}`,
                                data: [],
                                backgroundColor: colors[cluster % colors.length],
                                borderColor: colors[cluster % colors.length],
                                pointRadius: 6,
                                pointHoverRadius: 8
                            };
                        }
                        datasets[cluster].data.push({
                            x: point.x,
                            y: point.y,
                            title: point.title,
                            source: point.source,
                            bias_score: point.bias_score
                        });
                    });

                    new Chart(ctx, {
                        type: 'scatter',
                        data: { datasets: Object.values(datasets) },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                x: { title: { display: true, text: `${axisLabel} 1` } },
                                y: { title: { display: true, text: `${axisLabel} 2` } }
                            },
                            plugins: {
                                legend: { display: true, position: 'top' },
                                tooltip: {
                                    callbacks: {
                                        title: function(context) {
                                            return context[0].raw.title;
                                        },
                                        label: function(context) {
                                            return [
                                                `Source: ${context.raw.source}`,
                                                `Bias Score: ${context.raw.bias_score.toFixed(1)}/100`,
                                                `Coordinates: (${context.raw.x.toFixed(2)}, ${context.raw.y.toFixed(2)})`
                                            ];
                                        }
                                    }
                                }
                            }
                        }
                    });
                },

                renderBiasDistribution(containerId, data) {
                    const container = document.getElementById(containerId);
                    if (!container || !data.points) return;

                    container.innerHTML = `<canvas id="${containerId}Chart" class="w-full h-full"></canvas>`;
                    const canvas = container.querySelector('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    const colors = ['#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899'];
                    
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: data.points.map((_, i) => `Article ${i + 1}`),
                            datasets: [{
                                label: 'Bias Score',
                                data: data.points.map(p => p.bias_score),
                                borderColor: '#3b82f6',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                pointBackgroundColor: data.points.map(p => colors[p.cluster % colors.length]),
                                pointBorderColor: '#fff',
                                pointBorderWidth: 2,
                                pointRadius: 6,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: { 
                                    min: 0, 
                                    max: 100,
                                    title: { display: true, text: 'Bias Score (0-100)' }
                                },
                                x: { title: { display: true, text: 'Articles' } }
                            },
                            plugins: {
                                legend: { display: true },
                                tooltip: {
                                    callbacks: {
                                        title: function(context) {
                                            return data.points[context[0].dataIndex].title;
                                        },
                                        label: function(context) {
                                            const point = data.points[context.dataIndex];
                                            return [
                                                `Source: ${point.source}`,
                                                `Bias Score: ${point.bias_score.toFixed(1)}/100`,
                                                `Cluster: ${point.cluster + 1}`
                                            ];
                                        }
                                    }
                                }
                            }
                        }
                    });
                },

                updateRadarChart(scores) {
                    const ctx = document.getElementById('biasRadarChart').getContext('2d');
                    const data = {
                        labels: ['Ideological Stance', 'Factual Grounding', 'Framing Choices', 'Emotional Tone', 'Source Transparency'],
                        datasets: [{
                            label: 'Bias Score',
                            data: [
                                scores.ideological_stance,
                                scores.factual_grounding,
                                scores.framing_choices,
                                scores.emotional_tone,
                                scores.source_transparency
                            ],
                            backgroundColor: 'rgba(59, 130, 246, 0.2)',
                            borderColor: 'rgba(59, 130, 246, 1)',
                            borderWidth: 2,
                            pointBackgroundColor: 'rgba(59, 130, 246, 1)',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 6
                        }]
                    };

                    const options = {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            r: {
                                angleLines: { display: true },
                                suggestedMin: 0,
                                suggestedMax: 100,
                                ticks: { display: true, stepSize: 20 },
                                grid: { color: 'rgba(209, 213, 219, 0.5)' },
                                pointLabels: {
                                    font: { size: 12, weight: 'bold' },
                                    color: '#4b5563'
                                }
                            }
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.label}: ${context.raw}/100`;
                                    }
                                }
                            }
                        }
                    };

                    if (this.radarChart) this.radarChart.destroy();
                    this.radarChart = new Chart(ctx, { type: 'radar', data, options });
                },

                showPhraseDetails(phrase) {
                    const scoreImpacts = Object.entries(phrase.score_impact || {})
                        .map(([dim, impact]) => `${this.formatDimensionName(dim)}: ${impact > 0 ? '+' : ''}${impact.toFixed(1)}`)
                        .join('\n');
                    
                    alert(`Phrase: "${phrase.text}"\n\nExplanation: ${phrase.explanation}\n\nConfidence: ${phrase.confidence}%\n\nScore Impacts:\n${scoreImpacts}`);
                },

                getDimensionExplanation(dimension, score) {
                    const explanations = {
                        ideological_stance: score <= 20 ? 'Strong left/progressive bias' : score <= 40 ? 'Moderate left bias' : score <= 60 ? 'Center/balanced' : score <= 80 ? 'Moderate right bias' : 'Strong right/conservative bias',
                        factual_grounding: score <= 20 ? 'Unverified claims, no sources' : score <= 40 ? 'Poor verification, significant gaps' : score <= 60 ? 'Mixed verification, some issues' : score <= 80 ? 'Good verification, minor gaps' : 'Well-sourced, verified facts',
                        framing_choices: score <= 20 ? 'Heavy bias in emphasis/omission' : score <= 40 ? 'Significant biased framing' : score <= 60 ? 'Moderate bias, some balance' : score <= 80 ? 'Minimal bias, good balance' : 'Objective, balanced presentation',
                        emotional_tone: score <= 20 ? 'Highly inflammatory, emotional' : score <= 40 ? 'Significantly emotional' : score <= 60 ? 'Moderate emotion' : score <= 80 ? 'Minimal emotion' : 'Neutral, analytical tone',
                        source_transparency: score <= 20 ? 'Anonymous sources, "people say"' : score <= 40 ? 'Poor attribution, unclear sources' : score <= 60 ? 'Some attribution, mixed clarity' : score <= 80 ? 'Good attribution, clear sources' : 'Excellent transparency, named sources'
                    };
                    return explanations[dimension] || 'No explanation available';
                },

                getDetailedScoreExplanation(dimension, score) {
                    return `${score}/100 - ${this.getDimensionExplanation(dimension, score)}`;
                },

                getOverallScoreColor(score) {
                    if (score <= 30) return 'text-red-600';
                    if (score <= 50) return 'text-orange-600';
                    if (score <= 70) return 'text-yellow-600';
                    return 'text-green-600';
                },

                getOverallScoreDescription(score) {
                    if (score <= 20) return 'Very High Bias: Extreme bias across multiple dimensions.';
                    if (score <= 40) return 'High Bias: Significant bias with clear lean or strong emotional tone.';
                    if (score <= 60) return 'Moderate Bias: Some noticeable bias but attempts at balance.';
                    if (score <= 80) return 'Low Bias: Largely objective with minimal bias.';
                    return 'Very Low Bias: Highly objective, factual, and transparent.';
                },

                getDimensionScoreColor(score) {
                    if (score <= 30) return 'text-red-500';
                    if (score <= 50) return 'text-orange-500';
                    if (score <= 70) return 'text-yellow-500';
                    return 'text-green-500';
                },

                getFirstBiasPhrasesFromCluster(cluster) {
                    // Extract first few highlighted phrases from articles in the cluster
                    const phrases = [];
                    if (cluster && cluster.articles && Array.isArray(cluster.articles)) {
                        for (const article of cluster.articles.slice(0, 2)) {
                            if (article && article.analysis && article.analysis.highlighted_phrases && Array.isArray(article.analysis.highlighted_phrases)) {
                                const articlePhrases = article.analysis.highlighted_phrases
                                    .slice(0, 2)
                                    .map(p => (typeof p === 'object' && p.text) ? p.text : p)
                                    .filter(p => p && typeof p === 'string');
                                phrases.push(...articlePhrases);
                            }
                        }
                    }
                    return phrases.slice(0, 3); // Return max 3 phrases
                },

                formatDimensionName(dimension) {
                    return dimension.replace(/_/g, ' ').split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
                },

                getConfidenceInterval(confidenceIntervals, dimension) {
                    if (!confidenceIntervals || !confidenceIntervals[dimension]) {
                        return '(±10.0)';
                    }
                    const interval = confidenceIntervals[dimension];
                    if (Array.isArray(interval) && interval.length === 2) {
                        return `(${interval[0].toFixed(1)}-${interval[1].toFixed(1)})`;
                    }
                    return '(±10.0)';
                },

                truncateContent(content, maxLength) {
                    if (!content) return '';
                    if (content.length <= maxLength) return content;
                    return content.substring(0, maxLength) + '...';
                },

                async compareOutlets() {
                    this.comparisonLoading = true;
                    this.comparisonResults = null;

                    // Validate input
                    if (!this.comparisonData.article1.title || !this.comparisonData.article1.content || !this.comparisonData.article1.source ||
                        !this.comparisonData.article2.title || !this.comparisonData.article2.content || !this.comparisonData.article2.source) {
                        alert('Please fill in all fields for both articles to compare.');
                        this.comparisonLoading = false;
                        return;
                    }

                    try {
                        const articles = [
                            {
                                title: this.comparisonData.article1.title,
                                content: this.comparisonData.article1.content.substring(0, 1000), // Limit content length
                                source: this.comparisonData.article1.source
                            },
                            {
                                title: this.comparisonData.article2.title,
                                content: this.comparisonData.article2.content.substring(0, 1000), // Limit content length
                                source: this.comparisonData.article2.source
                            }
                        ];

                        const response = await fetch('/compare/outlets', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ articles })
                        });

                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.detail || 'Failed to compare outlets');
                        }

                        this.comparisonResults = await response.json();
                    } catch (error) {
                        alert(`Comparison failed: ${error.message}`);
                        console.error('Comparison error:', error);
                    } finally {
                        this.comparisonLoading = false;
                    }
                },

                async autoCompareOutlets() {
                    this.comparisonLoading = true;
                    this.comparisonResults = null;

                    try {
                        const response = await fetch('/compare/auto', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' }
                        });

                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.detail || 'Failed to auto-compare outlets');
                        }

                        this.comparisonResults = await response.json();
                    } catch (error) {
                        alert(`Auto-comparison failed: ${error.message}`);
                        console.error('Auto-comparison error:', error);
                    } finally {
                        this.comparisonLoading = false;
                    }
                },

                formatComparisonAnalysis(analysis) {
                    if (!analysis) return '';
                    
                    // Clean up the text formatting issues
                    let cleaned = analysis
                        // Remove leading ": " from paragraphs that start with it
                        .replace(/^:\s*/gm, '')
                        // Remove trailing "-" dashes that separate paragraphs
                        .replace(/\s*-\s*$/gm, '')
                        // Clean up multiple dashes
                        .replace(/\s*-\s*\n\s*-\s*/g, '\n\n')
                        // Remove single dashes at line ends
                        .replace(/\s*-\s*$/gm, '')
                        // Clean up extra whitespace
                        .replace(/\n\s*\n\s*\n/g, '\n\n')
                        .trim();
                    
                    // Convert markdown to HTML with proper formatting
                    let formatted = cleaned
                        // Convert **bold** to proper headers with styling
                        .replace(/\*\*(.*?)\*\*/g, '<h4 class="text-lg font-semibold text-gray-900 mb-3 mt-6 first:mt-0 border-b border-gray-200 pb-2">$1</h4>')
                        // Convert double line breaks to proper paragraph spacing
                        .replace(/\n\n/g, '</p><p class="text-sm text-gray-700 leading-relaxed mb-4">')
                        // Convert single line breaks to <br> for line breaks within paragraphs
                        .replace(/\n/g, '<br>');
                    
                    // Wrap in paragraphs
                    formatted = '<p class="text-sm text-gray-700 leading-relaxed mb-4">' + formatted + '</p>';
                    
                    // Clean up any empty paragraphs
                    formatted = formatted.replace(/<p class="text-sm text-gray-700 leading-relaxed mb-4"><\/p>/g, '');
                    
                    // Add some spacing after headers
                    formatted = formatted.replace(/(<h4[^>]*>.*?<\/h4>)/g, '$1<div class="mb-2"></div>');
                    
                    return formatted;
                }
            }
        }
    </script>
</body>
</html>